# è´¨é‡ä¿è¯å·¥ä½œæµ
name: Quality Assurance Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_DEFAULT_VERSION: "3.12"

jobs:
  # å¿«é€Ÿæ£€æŸ¥é˜¶æ®µ - å¹¶è¡Œæ‰§è¡Œ
  quick-checks:
    name: "å¿«é€Ÿæ£€æŸ¥"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: å®‰è£… UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-python-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-python-${{ matrix.python-version }}-

    - name: å®‰è£…ä¾èµ–
      run: uv sync --all-extras

    - name: ä»£ç æ ¼å¼æ£€æŸ¥ (Black)
      run: uv run black --check --diff src tests

    - name: å¯¼å…¥æ’åºæ£€æŸ¥ (isort)
      run: uv run isort --check-only --diff src tests

    - name: ä»£ç é£æ ¼æ£€æŸ¥ (flake8)
      run: uv run flake8 src tests

    - name: å¿«é€Ÿå®‰å…¨æ‰«æ (bandit)
      run: uv run bandit -r src -c pyproject.toml

    - name: æ–‡æ¡£å­—ç¬¦ä¸²æ£€æŸ¥ (pydocstyle)
      run: |
        if command -v pydocstyle &> /dev/null; then
          uv run pydocstyle src/ || true  # éé˜»å¡æ£€æŸ¥
        fi

  # æ·±åº¦æ£€æŸ¥é˜¶æ®µ
  deep-checks:
    name: "æ·±åº¦æ£€æŸ¥"
    runs-on: ubuntu-latest
    needs: quick-checks
    strategy:
      matrix:
        python-version: ["3.12"]  # ä¸»ç‰ˆæœ¬è¯¦ç»†æ£€æŸ¥

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: å®‰è£… UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: å®‰è£…ä¾èµ–
      run: uv sync --all-extras

    - name: ç±»å‹æ£€æŸ¥ (MyPy)
      run: uv run mypy src --strict

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        uv run pytest tests/unit/ -v \
          --cov=src/ontology_framework \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --junitxml=junit.xml

    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        uv run pytest tests/integration/ -v \
          --junitxml=junit-integration.xml

    - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        uv run pytest tests/performance/ -v \
          --benchmark-only \
          --benchmark-json=benchmark.json

    - name: æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

    - name: å‘å¸ƒæµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          junit.xml
          junit-integration.xml
          benchmark.json
          htmlcov/

    - name: å‘å¸ƒæ€§èƒ½åŸºå‡†
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: benchmark-results
        path: benchmark.json

  # å®‰å…¨æ£€æŸ¥é˜¶æ®µ
  security-scan:
    name: "å®‰å…¨æ‰«æ"
    runs-on: ubuntu-latest
    needs: quick-checks

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: å®‰è£…ä¾èµ–
      run: uv sync --all-extras

    - name: å®‰å…¨æ¼æ´æ‰«æ (Safety)
      run: uv run safety check --json --output safety-report.json || true

    - name: å®Œæ•´å®‰å…¨æ‰«æ (Bandit)
      run: uv run bandit -r src -f json -o bandit-report.json

    - name: ä»£ç è´¨é‡æ‰«æ (CodeQL)
      uses: github/codeql-action/analyze@v2
      with:
        languages: python

    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json

  # è´¨é‡é—¨æ§æ£€æŸ¥
  quality-gate:
    name: "è´¨é‡é—¨æ§"
    runs-on: ubuntu-latest
    needs: [quick-checks, deep-checks, security-scan]
    if: always()

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æµ‹è¯•ç»“æœ
      uses: actions/download-artifact@v3
      with:
        name: test-results-3.12
        path: ./test-results/

    - name: ä¸‹è½½å®‰å…¨æŠ¥å‘Š
      uses: actions/download-artifact@v3
      with:
        name: security-reports
        path: ./security-reports/

    - name: è´¨é‡é—¨æ§æ£€æŸ¥
      run: |
        python - << 'EOF'
        import json
        import xml.etree.ElementTree as ET
        from pathlib import Path

        def parse_junit_xml(file_path):
            """è§£æJUnit XMLæ–‡ä»¶"""
            if not Path(file_path).exists():
                return {"tests": 0, "failures": 0, "errors": 0}

            tree = ET.parse(file_path)
            root = tree.getroot()

            tests = int(root.get("tests", 0))
            failures = int(root.get("failures", 0))
            errors = int(root.get("errors", 0))

            return {"tests": tests, "failures": failures, "errors": errors}

        def check_quality_gate():
            """æ£€æŸ¥è´¨é‡é—¨æ§"""
            results = {
                "tests_passed": True,
                "security_passed": True,
                "details": []
            }

            # æ£€æŸ¥æµ‹è¯•ç»“æœ
            unit_results = parse_junit_xml("test-results/junit.xml")
            integration_results = parse_junit_xml("test-results/junit-integration.xml")

            total_failures = unit_results["failures"] + integration_results["failures"] + unit_results["errors"] + integration_results["errors"]

            if total_failures > 0:
                results["tests_passed"] = False
                results["details"].append(f"æµ‹è¯•å¤±è´¥: {total_failures} ä¸ªæµ‹è¯•ç”¨ä¾‹å¤±è´¥")
            else:
                results["details"].append(f"æµ‹è¯•é€šè¿‡: {unit_results['tests'] + integration_results['tests']} ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡")

            # æ£€æŸ¥å®‰å…¨æŠ¥å‘Š
            try:
                with open("security-reports/bandit-report.json", "r") as f:
                    bandit_report = json.load(f)

                high_issues = len([r for r in bandit_report["results"] if r["issue_severity"] == "HIGH"])
                medium_issues = len([r for r in bandit_report["results"] if r["issue_severity"] == "MEDIUM"])

                if high_issues > 0:
                    results["security_passed"] = False
                    results["details"].append(f"é«˜é£é™©å®‰å…¨é—®é¢˜: {high_issues} ä¸ª")
                elif medium_issues > 5:
                    results["security_passed"] = False
                    results["details"].append(f"ä¸­é£é™©å®‰å…¨é—®é¢˜è¿‡å¤š: {medium_issues} ä¸ª")
                else:
                    results["details"].append(f"å®‰å…¨æ£€æŸ¥é€šè¿‡: {high_issues} é«˜é£é™©, {medium_issues} ä¸­é£é™©")

            except FileNotFoundError:
                results["details"].append("å®‰å…¨æŠ¥å‘Šæœªæ‰¾åˆ°ï¼Œè·³è¿‡å®‰å…¨æ£€æŸ¥")

            return results

        # æ‰§è¡Œè´¨é‡é—¨æ§æ£€æŸ¥
        gate_results = check_quality_gate()

        print("=== è´¨é‡é—¨æ§æ£€æŸ¥ç»“æœ ===")
        for detail in gate_results["details"]:
            print(f"â€¢ {detail}")

        overall_passed = gate_results["tests_passed"] and gate_results["security_passed"]

        if overall_passed:
            print("\nâœ… è´¨é‡é—¨æ§æ£€æŸ¥é€šè¿‡")
            exit(0)
        else:
            print("\nâŒ è´¨é‡é—¨æ§æ£€æŸ¥å¤±è´¥")
            exit(1)
        EOF

    - name: è´¨é‡æ£€æŸ¥æ€»ç»“
      run: |
        echo "## ğŸ“Š è´¨é‡æ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.deep-checks.result }}" == "success" ]; then
          echo "âœ… æ·±åº¦æ£€æŸ¥: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ æ·±åº¦æ£€æŸ¥: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "âœ… å®‰å…¨æ‰«æ: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ å®‰å…¨æ‰«æ: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.quick-checks.result }}" == "success" ]; then
          echo "âœ… å¿«é€Ÿæ£€æŸ¥: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ å¿«é€Ÿæ£€æŸ¥: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi

  # éƒ¨ç½²å‡†å¤‡é˜¶æ®µ (ä»…mainåˆ†æ”¯)
  deployment-prep:
    name: "éƒ¨ç½²å‡†å¤‡"
    runs-on: ubuntu-latest
    needs: [quick-checks, deep-checks, security-scan, quality-gate]
    if: github.ref == 'refs/heads/main' && needs.quality-gate.result == 'success'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: å®‰è£…ä¾èµ–
      run: uv sync --all-extras

    - name: æ„å»ºåŒ…
      run: uv build

    - name: è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
      run: uv run pytest tests/e2e/ -v

    - name: ç”Ÿæˆæ–‡æ¡£
      run: |
        if command -v mkdocs &> /dev/null; then
          uv run mkdocs build
        else
          echo "MkDocs not available, skipping documentation build"
        fi

    - name: å‘å¸ƒæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          dist/
          site/